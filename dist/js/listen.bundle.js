"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function init(){$disconnect.show("inline"),signal=new Signal({uuid:uuid}),listen=new Listener({$video:$video,signal:signal}),signal.start(),listen.start()}function disconnect(){var e=location.protocol+"//"+location.host+"/listen";location.href=e}function toggleAudio(){return $toggleAudioBtn.className.match(/active/)?($toggleAudioBtn.className=$toggleAudioBtn.className.replace(" active",""),void listen.disableAudio()):($toggleAudioBtn.className+=" active",void listen.enableAudio())}function expand(){return $expandBtn.className.match(/active/)?($expandBtn.className=$expandBtn.className.replace(" active",""),void($video.style.width="auto")):($expandBtn.className+=" active",void($video.style.width="100%"))}function reloadStreamer(){listen.reloadStreamer()}function connect(e,n){var t=n.keyCode;if(13===t){uuid=e.value.trim();var o=location.protocol+"//"+location.host+"/listen/"+uuid;location.href=o}return t<65||91===t||(e.value=e.value.replace(/\s/gi,"-"),!0)}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),El=function(){function e(n){_classCallCheck(this,e),"string"==typeof n&&(n=document.getElementById(n)),this.$el=n}return _createClass(e,[{key:"get",value:function(){return this.$el}},{key:"show",value:function(e){return this.$el.style.display=e||"block",this}},{key:"hide",value:function(){return this.$el.style.display="none",this}},{key:"focus",value:function(){return this.$el.focus(),this}},{key:"html",value:function(e){return this.$el.innerHTML=e,this}}]),e}(),Listener=function(){function e(n){_classCallCheck(this,e);var t=n||{},o=t.$video,i=t.signal;this.signal=i,this.$video=o,this.stream=null,this.pc=null,this.config={iceServers:[{url:"stun:stun.l.google.com:19302"}]}}return _createClass(e,[{key:"start",value:function(){this.setEvents(),this.connect()}},{key:"setEvents",value:function(){var e=this;window.onbeforeunload=function(){sendMessage("bye")},this.signal.on("offer",function(n){return e.onOffer(n)}),this.signal.on("answer",function(n){return e.onAnswer(n)}),this.signal.on("candidate",function(n){return e.onCandidate(n)}),this.signal.on("media",function(n){return e.onMedia(n)}),this.signal.on("bye",function(n){return e.onBye(n)})}},{key:"reloadStreamer",value:function(){this.signal.send({type:"reload"})}},{key:"enableAudio",value:function(){this.signal.send({type:"enable-audio"})}},{key:"disableAudio",value:function(){this.signal.send({type:"disable-audio"})}},{key:"onOffer",value:function(e){var n=this;console.log("-- got offer:",e),this.connect(),this.pc.setRemoteDescription(new RTCSessionDescription(e),function(){n.answer()})}},{key:"onAnswer",value:function(e){console.log("-- got answer:",e),this.pc.setRemoteDescription(new RTCSessionDescription(e))}},{key:"onCandidate",value:function(e){console.log("-- got candidate:",e);var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.pc.addIceCandidate(n)}},{key:"onMedia",value:function(e){console.log("-- got media:",e),this.connect()}},{key:"onBye",value:function(e){console.log("-- client disconnected:",e),this.handleRemoteHangup()}},{key:"connect",value:function(){this.createPeerConnection(),this.offer()}},{key:"createPeerConnection",value:function(){var e=this;try{this.pc=new RTCPeerConnection(this.config),this.pc.onicecandidate=function(n){return e.onIceCandidate(n)},this.pc.onaddstream=function(n){return e.onRemoteStreamAdded(event)},this.pc.onremovestream=function(n){return e.onRemoteStreamRemoved(n)},console.log("Created RTCPeerConnnection")}catch(e){return console.log("Failed to create PeerConnection, exception: "+e.message),void alert("Cannot create RTCPeerConnection object.")}}},{key:"onIceCandidate",value:function(e){return console.log("-- got ice candidate event: ",e),e.candidate?void this.signal.send({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}):void console.log("End of candidates.")}},{key:"onRemoteStreamAdded",value:function(e){console.log("Remote stream added."),this.$video.src=window.URL.createObjectURL(e.stream),this.stream=e.stream,window.stream=e.stream}},{key:"handleCreateOfferError",value:function(e){console.log("createOffer() error: ",e)}},{key:"offer",value:function(){var e=this;console.log("-- offer: Sending offer to peer"),this.pc.createOffer(function(n){return e.describe(n)},function(n){return e.handleCreateOfferError(n)})}},{key:"answer",value:function(){var e=this;console.log("-- answer: Sending answer to peer."),this.pc.createAnswer().then(function(n){return e.describe(n)},function(n){return e.onCreateSessionDescriptionError(n)})}},{key:"describe",value:function(e){var n=this;this.pc.setLocalDescription(e,function(){console.log("set local session description",e),n.signal.send(e)})}},{key:"onCreateSessionDescriptionError",value:function(e){console.error("Failed to create session description: ",e.toString()),console.error("STACK TRACE:",e.stack)}},{key:"onRemoteStreamRemoved",value:function(e){console.log("Remote stream removed. Event: ",e)}},{key:"hangup",value:function(){console.log("Hanging up."),this.stop(),this.signal.send("bye")}},{key:"handleRemoteHangup",value:function(){console.log("Session terminated."),stop()}},{key:"stop",value:function(){isStarted=!1,pc.close(),pc=null}}]),e}(),Signal=function(){function e(n){var t=this,o=n.uuid;_classCallCheck(this,e),this.host=location.protocol+"//"+location.host,this.isChannelReady=!1,this.socket=null,this.uuid=o,this.validEvents=["media","offer","answer","candidate","bye","reload","enable-audio","disable-audio"],this.listeners={},this.validEvents.map(function(e){t.listeners[e]=[]})}return _createClass(e,[{key:"start",value:function(){this.socket=io.connect(),console.log("-- started @ "+this.host),this.setEvents()}},{key:"createRoom",value:function(){var e=prompt("Enter room name:");e=e||"default",console.log('[ signal ]--> set room name: "'+e+'"'),this.socket.emit("create",e),console.log('[ signal ]--> creating room "'+e+'"')}},{key:"setEvents",value:function(){var e=this;this.socket.on("connect",function(){console.log("[ signal ]--> connected; enter room "+e.uuid),e.socket.emit("room",e.uuid)}),this.socket.on("created",function(e){console.log('[ signal ]--> created room "'+e+'"')}),this.socket.on("full",function(e){console.log('[ signal ]--> room "'+e+'" is full')}),this.socket.on("join",function(n){console.log('[ signal ]--> Another peer made a request to join room "'+n+'"'),console.log('[ signal ]--> This peer is the initiator of room "'+n+'"'),e.isChannelReady=!0}),this.socket.on("joined",function(e){console.log("[ signal ]--> joined: "+e),this.isChannelReady=!0}),this.socket.on("log",function(e){console.log.apply(console,e)}),this.socket.on("error",function(e){console.log("[ signal ]--> SOCKET ERROR:",e)}),this.socket.on("message",function(n){return e.onMessage(n)})}},{key:"onMessage",value:function(e){if(console.log("[ signal ]--> got message:",e),!this.validEvents.includes(e.type))throw new Error('No message handler for type "'+e.type+'"');this.listeners[e.type].map(function(n){return n(e)})}},{key:"on",value:function(e,n){if(!this.validEvents.includes(e))throw new Error("ERROR: invalid event: "+e);this.listeners[e].push(n)}},{key:"send",value:function(e){console.log("[ signal ]--> sending message:",e),this.socket.emit("message",e)}}]),e}(),signal=void 0,listen=void 0,$video=document.querySelector("video"),$toggleAudioBtn=new El("toggleAudio").get(),$expandBtn=new El("expand").get(),uuid=void 0,$room=new El("room"),$disconnect=new El("disconnect");"/listen"!==location.pathname&&"/listen/"!==location.pathname?(uuid=location.pathname.replace("/listen/",""),init()):$room.show();