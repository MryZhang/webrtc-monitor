"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,o,t){return o&&e(n.prototype,o),t&&e(n,t),n}}(),Streamer=function(){function e(n){_classCallCheck(this,e);var o=n||{},t=o.$video,i=o.signal;this.signal=i,this.$video=t,this.stream=null,this.pc=null,this.constraints={audio:!0,video:!0}}return _createClass(e,[{key:"start",value:function(){var e=this;this.setEvents(),navigator.mediaDevices.getUserMedia(this.constraints).then(function(n){return e.gotStream(n)}).catch(function(e){alert("Error: "+e.name),console.log("ERROR getting media:",e),console.log("STACK TRACE:",e.stack)})}},{key:"setEvents",value:function(){var e=this;window.onbeforeunload=function(){sendMessage("bye")},this.signal.on("offer",function(n){return e.onOffer(n)}),this.signal.on("answer",function(n){return e.onAnswer(n)}),this.signal.on("candidate",function(n){return e.onRemoteIceCandidate(n)}),this.signal.on("media",function(n){return e.onMedia(n)}),this.signal.on("bye",function(n){return e.onBye(n)}),this.signal.on("reload",function(n){return e.onReload(n)}),this.signal.on("enable-audio",function(n){return e.onEnableAudio(n)}),this.signal.on("disable-audio",function(n){return e.onDisableAudio(n)})}},{key:"onOffer",value:function(e){var n=this;console.log("-- got offer:",e),this.connect(),this.pc.setRemoteDescription(new RTCSessionDescription(e),function(){n.answer()})}},{key:"onAnswer",value:function(e){console.log("-- got answer:",e),this.pc.setRemoteDescription(new RTCSessionDescription(e))}},{key:"onRemoteIceCandidate",value:function(e){console.log("-- got candidate:",e);var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.pc.addIceCandidate(n)}},{key:"onMedia",value:function(e){console.log("-- got media:",e),this.connect()}},{key:"onBye",value:function(e){console.log("-- client disconnected:",e),this.handleRemoteHangup()}},{key:"onReload",value:function(e){console.log("-- reload streamer:",e),location.reload()}},{key:"onEnableAudio",value:function(e){console.log("-- enable audio:",e),this.stream.getAudioTracks()[0].enabled=!0}},{key:"onDisableAudio",value:function(e){console.log("-- disable audio:",e),this.stream.getAudioTracks()[0].enabled=!1}},{key:"gotStream",value:function(e){console.log("Adding local stream"),e.getAudioTracks()[0].enabled=!1,this.stream=e,this.signal.send({type:"media"}),this.connect()}},{key:"getStream",value:function(){return this.stream}},{key:"connect",value:function(){this.createPeerConnection(),this.pc.addStream(this.stream),this.offer()}},{key:"createPeerConnection",value:function(){var e=this;try{this.pc=new RTCPeerConnection(null),this.pc.onicecandidate=function(n){return e.onLocalIceCandidate(n)},console.log("Created RTCPeerConnnection")}catch(e){return console.log("Failed to create PeerConnection, exception: "+e.message),void alert("Cannot create RTCPeerConnection object.")}}},{key:"onLocalIceCandidate",value:function(e){return console.log("-- got local ice candidate event: ",e),e.candidate?void this.signal.send({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}):void console.log("End of candidates.")}},{key:"handleCreateOfferError",value:function(e){console.log("createOffer() error: ",e)}},{key:"offer",value:function(){var e=this;console.log("-- offer: Sending offer to peer"),this.pc.createOffer(function(n){return e.describe(n)},function(n){return e.handleCreateOfferError(n)})}},{key:"answer",value:function(){var e=this;this.connect(),console.log("-- answer: Sending answer to peer."),this.pc.createAnswer().then(function(n){return e.describe(n)},function(n){return e.onCreateSessionDescriptionError(n)})}},{key:"describe",value:function(e){var n=this;this.pc.setLocalDescription(e,function(){console.log("set local session description",e),n.signal.send(e)})}},{key:"onCreateSessionDescriptionError",value:function(e){console.error("Failed to create session description: ",e.toString()),console.error("STACK TRACE:",e.stack)}},{key:"onRemoteStreamRemoved",value:function(e){console.log("Remote stream removed. Event: ",e)}},{key:"hangup",value:function(){console.log("Hanging up."),this.stop(),this.signal.send("bye")}},{key:"handleRemoteHangup",value:function(){console.log("Session terminated."),stop()}},{key:"stop",value:function(){pc.close(),pc=null}}]),e}(),Turn=function(){function e(n){_classCallCheck(this,e),this.config=n}return _createClass(e,[{key:"request",value:function(e){var n=!1;for(var o in this.config.iceServers)if("turn:"===this.config.iceServers[o].url.substr(0,5)){n=!0,turnReady=!0;break}n||!function(){console.log("Getting TURN server from ",e);var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){var e=JSON.parse(n.responseText);console.log("Got TURN server: ",e),this.config.iceServers.push({url:"turn:"+e.username+"@"+e.turn,credential:e.password}),turnReady=!0}},n.open("GET",e,!0),n.send()}()}}]),e}(),Opus=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"prefer",value:function(e){for(var n,o=e.split("\r\n"),t=0;t<o.length;t++)if(o[t].search("m=audio")!==-1){n=t;break}if(null===n)return e;for(t=0;t<o.length;t++)if(o[t].search("opus/48000")!==-1){var i=this.extractSdp(o[t],/:(\d+) opus\/48000/i);i&&(o[n]=this.setDefaultCodec(o[n],i));break}return o=this.removeCN(o,n),e=o.join("\r\n")}},{key:"extractSdp",value:function(e,n){var o=e.match(n);return o&&2===o.length?o[1]:null}},{key:"setDefaultCodec",value:function(e,n){for(var o=e.split(" "),t=[],i=0,s=0;s<o.length;s++)3===i&&(t[i++]=n),o[s]!==n&&(t[i++]=o[s]);return t.join(" ")}},{key:"removeCN",value:function(e,n){for(var o=e[n].split(" "),t=e.length-1;t>=0;t--){var i=this.extractSdp(e[t],/a=rtpmap:(\d+) CN\/\d+/i);if(i){var s=o.indexOf(i);s!==-1&&o.splice(s,1),e.splice(t,1)}}return e[n]=o.join(" "),e}}]),e}(),Signal=function(){function e(n){var o=this,t=n.uuid;_classCallCheck(this,e),this.host=location.protocol+"//"+location.host,this.isChannelReady=!1,this.socket=null,this.uuid=t,this.validEvents=["media","offer","answer","candidate","bye","reload","enable-audio","disable-audio"],this.listeners={},this.validEvents.map(function(e){o.listeners[e]=[]}),this.config={iceServers:[{url:"stun:stun.l.google.com:19302"}]},this.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}return _createClass(e,[{key:"start",value:function(){this.socket=io.connect(),console.log("-- started @ "+this.host),this.setEvents()}},{key:"createRoom",value:function(){var e=prompt("Enter room name:");e=e||"default",console.log('[ signal ]--> set room name: "'+e+'"'),this.socket.emit("create",e),console.log('[ signal ]--> creating room "'+e+'"')}},{key:"setEvents",value:function(){var e=this;this.socket.on("connect",function(){console.log("[ signal ]--> connected; enter room "+e.uuid),e.socket.emit("room",e.uuid)}),this.socket.on("created",function(e){console.log('[ signal ]--> created room "'+e+'"')}),this.socket.on("full",function(e){console.log('[ signal ]--> room "'+e+'" is full')}),this.socket.on("join",function(n){console.log('[ signal ]--> Another peer made a request to join room "'+n+'"'),console.log('[ signal ]--> This peer is the initiator of room "'+n+'"'),e.isChannelReady=!0}),this.socket.on("joined",function(e){console.log("[ signal ]--> joined: "+e),this.isChannelReady=!0}),this.socket.on("log",function(e){console.log.apply(console,e)}),this.socket.on("error",function(e){console.log("[ signal ]--> SOCKET ERROR:",e)}),this.socket.on("message",function(n){return e.onMessage(n)})}},{key:"onMessage",value:function(e){if(console.log("[ signal ]--> got message:",e),!this.validEvents.includes(e.type))throw new Error('No message handler for type "'+e.type+'"');this.listeners[e.type].map(function(n){return n(e)})}},{key:"on",value:function(e,n){if(!this.validEvents.includes(e))throw new Error("ERROR: invalid event: "+e);this.listeners[e].push(n)}},{key:"send",value:function(e){console.log("[ signal ]--> sending message:",e),this.socket.emit("message",e)}}]),e}(),uuid=location.pathname.replace("/stream/",""),signal=new Signal({uuid:uuid}),stream=new Streamer({signal:signal});signal.start(),stream.start(),new Clipboard("#copy",{text:function(){return console.log("-- set clipboard:",uuid),uuid}});